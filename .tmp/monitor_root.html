<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GAIA Monitor</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 16px; }
      .event { border-bottom: 1px solid #eee; padding: 8px 0; }
      .ts { color: #666; font-size: 0.9em }
      pre { white-space: pre-wrap; word-break: break-word; }
    </style>
  </head>
  <body>
    <h1>GAIA / Alby Monitor</h1>
    <p>Lightweight dashboard inspired by Alby prototypes (ports 8000, 8001). Start simple — tabs below are placeholders for incremental features.</p>

    <div style="margin-bottom:12px">
      <button id="startBtn">Start Agents</button>
      <button id="stopBtn">Stop Agents</button>
      <span id="agentStatus" style="margin-left:12px;color:#333">Status: unknown</span>
    </div>

    <div id="tabs">
      <button class="tabbtn" data-tab="overview">Overview</button>
      <button class="tabbtn" data-tab="events">Events</button>
      <button class="tabbtn" data-tab="agents">Agents</button>
      <button class="tabbtn" data-tab="capabilities">Capabilities</button>
      <button class="tabbtn" data-tab="logs">Logs</button>
    </div>

    <div id="tab-content">
      <div id="overview" class="tabpanel">
        <h2>Overview</h2>
        <p>Reference: older Alby prototypes ran on ports <strong>8000</strong> (prototype) and <strong>8001</strong> (improved). Key ideas:
        <ul>
          <li>Show agent status & uptime</li>
          <li>Quick actions: start/stop agents, run publisher</li>
          <li>Summarize capability schema (name, version, channels, internet_access, auth)</li>
        </ul>
        </p>
        <p><strong>Next:</strong> Replace placeholders with live metrics (agent health, task queues).</p>
      </div>

      <div id="events" class="tabpanel" style="display:none">
        <h2>Events</h2>
        <p>Auto-refreshes every 2s. Source: <code>events.ndjson</code></p>
        <div id="events-list"></div>
      </div>

      <div id="agents" class="tabpanel" style="display:none">
        <h2>Agents</h2>
        <div id="agents-list"><em>Loading agent status...</em></div>
        <pre id="out-status" style="background:#f6f6f6;padding:8px;border:1px solid #eee;max-height:240px;overflow:auto"></pre>
        <p>Placeholder: show `out/status.json`-style info from older Alby (name, version, channels, internet_access, auth-type).</p>
      </div>

      <div id="capabilities" class="tabpanel" style="display:none">
        <h2>Capabilities</h2>
        <div id="cap-list"><em>Capability files will be summarized here (name, skills, parameters).</em></div>
        <ul id="cap-summaries"></ul>
        <div id="cap-detail" style="margin-top:12px;background:#fff;padding:8px;border:1px solid #eee;max-height:400px;overflow:auto;display:none">
          <h3 id="cap-title"></h3>
          <div id="cap-meta"></div>
          <h4>Skills</h4>
          <div id="cap-skills"></div>
          <h4>Raw JSON</h4>
          <pre id="cap-raw" style="background:#f6f6f6;padding:8px;border:1px solid #eee;white-space:pre-wrap"></pre>
        </div>
        <p>Reference capability schema (from Alby 0.2): <code>name, version, channels, owner, internet_access, auth.token_env, skills[]</code></p>
      </div>

      <div id="logs" class="tabpanel" style="display:none">
        <h2>Logs</h2>
        <p>Quick access to recent log files under <code>.tmp/logs</code>. Use rotate helper for cleanup.</p>
        <div id="logs-list"><em>Logs list placeholder</em></div>
      </div>
    </div>

    <script>
      async function fetchEvents(){
        try{
          const res = await fetch('/api/events?n=50');
          const ev = await res.json();
          const container = document.getElementById('events-list');
          container.innerHTML = '';
          for(const e of ev.reverse()){
            const div = document.createElement('div');
            div.className = 'event';
            const header = document.createElement('div');
            header.innerHTML = `<strong>${e.type||''}</strong> <span class='ts'>${e.timestamp||''}</span>`;
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(e.payload || e, null, 2);
            div.appendChild(header);
            div.appendChild(pre);
            container.appendChild(div);
          }
        }catch(err){ console.error(err); }
      }
      fetchEvents();
      setInterval(fetchEvents, 2000);

      // tabs behaviour
      document.querySelectorAll('.tabbtn').forEach(b=>{
        b.addEventListener('click', ()=>{
          const tab = b.dataset.tab;
          document.querySelectorAll('.tabpanel').forEach(p=>p.style.display='none');
          document.getElementById(tab).style.display='block';
        });
      });
      // default show overview
      document.querySelector('.tabbtn[data-tab="overview"]').click();

      async function fetchStatus(){
        try{
          const r = await fetch('/api/agents/status');
          const s = await r.json();
          const stat = document.getElementById('agentStatus');
          stat.textContent = s.running ? ('Running (' + (s.pids ? Object.keys(s.pids).length : '?') + ' agents)') : 'Stopped';
          // fetch out/status.json if present
          try{
            const osr = await fetch('/api/agents/out_status');
            const osj = await osr.json();
            const outEl = document.getElementById('out-status');
            if (osj.found && osj.data){
              outEl.textContent = JSON.stringify(osj.data, null, 2);
            } else if (osj.found && osj.error){
              outEl.textContent = 'Error reading ' + osj.path + ': ' + osj.error;
            } else {
              outEl.textContent = 'No out/status.json present';
            }
          }catch(e){ console.error(e); }
          // fetch capabilities
          try{
            const cr = await fetch('/api/agents/capabilities');
            const cj = await cr.json();
            const ul = document.getElementById('cap-summaries');
            ul.innerHTML = '';
            if (cj && cj.length){
              for(const c of cj){
                  const li = document.createElement('li');
                  li.textContent = `${c.path} — ${c.name||'<unnamed>'} v${c.version||''} skills:${(c.skills||[]).join(',')}`;
                  li.style.cursor = 'pointer';
                  li.dataset.path = c.path;
                  li.addEventListener('click', async ()=>{
                    const p = li.dataset.path;
                    const r = await fetch('/api/agents/capability?path='+encodeURIComponent(p));
                    const j = await r.json();
                    if (j.data){
                      document.getElementById('cap-detail').style.display = 'block';
                      document.getElementById('cap-title').textContent = (j.data.name||p) + (j.data.version ? (' v'+j.data.version) : '');
                      document.getElementById('cap-meta').innerHTML = `<strong>Channels:</strong> ${JSON.stringify(j.data.channels||[])}<br/><strong>Internet:</strong> ${j.data.internet_access}`;
                      // render skills
                      const skillsDiv = document.getElementById('cap-skills'); skillsDiv.innerHTML = '';
                      if (Array.isArray(j.data.skills) && j.data.skills.length){
                        const tbl = document.createElement('table'); tbl.style.width='100%'; tbl.border=1;
                        const hdr = document.createElement('tr'); hdr.innerHTML = '<th>id</th><th>description</th><th>parameters</th>'; tbl.appendChild(hdr);
                        for(const s of j.data.skills){
                          const tr = document.createElement('tr');
                          let id = typeof s === 'string' ? s : (s.id||'');
                          let desc = typeof s === 'string' ? '' : (s.description||'');
                          let params = typeof s === 'string' ? '' : JSON.stringify(s.parameters||{});
                          tr.innerHTML = `<td>${id}</td><td>${desc}</td><td>${params}</td>`;
                          tbl.appendChild(tr);
                        }
                        skillsDiv.appendChild(tbl);
                      } else {
                        skillsDiv.textContent = 'No skills array found';
                      }
                      document.getElementById('cap-raw').textContent = JSON.stringify(j.data, null, 2);
                    } else {
                      alert('Failed to load capability: '+(j.error||'unknown'));
                    }
                  });
                  ul.appendChild(li);
                }
            } else {
              const li = document.createElement('li'); li.textContent = 'No capability files detected'; ul.appendChild(li);
            }
          }catch(e){ console.error(e); }
        }catch(e){ console.error(e); }
      }
      fetchStatus();
      setInterval(fetchStatus, 3000);

      document.getElementById('startBtn').addEventListener('click', async ()=>{
        const b = document.getElementById('startBtn'); b.disabled = true;
        const res = await fetch('/api/agents/start', { method: 'POST' });
        const j = await res.json();
        alert(JSON.stringify(j));
        b.disabled = false;
      });

      document.getElementById('stopBtn').addEventListener('click', async ()=>{
        if (!confirm('Stop agents?')) return;
        const b = document.getElementById('stopBtn'); b.disabled = true;
        const res = await fetch('/api/agents/stop', { method: 'POST' });
        const j = await res.json();
        alert(JSON.stringify(j));
        b.disabled = false;
      });
    </script>
  </body>
</html>