name: rotate-secret

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 3 * * 0' # weekly
  env:
    GAIA_TOKEN: ${{ secrets.GAIA_GITHUB_TOKEN || github.token }}

jobs:
  rotate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y openssl curl gh

      - name: Generate token
        id: gen
        run: |
          NEW_TOKEN=$(openssl rand -base64 32)
          echo "NEW_TOKEN=$NEW_TOKEN" >> $GITHUB_ENV

      - name: Authenticate gh (requires credentials)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$GITHUB_TOKEN" | gh auth login --with-token || true
          gh --version

      - name: Set repository secret (example)
        run: |
          # NOTE: GitHub policy may prevent using GITHUB_TOKEN to create repo secrets.
          # Replace this step with a service account PAT if required.
          gh secret set MY_TOKEN --body "$NEW_TOKEN" || echo "Set secret failed (check permissions)"

      - name: Run smoke check
        run: |
          chmod +x ./scripts/smoke_check_with_token.sh || true
          ./scripts/smoke_check_with_token.sh "$NEW_TOKEN"

      - name: Post-check guidance
        run: |
          echo "If smoke check passed, consider revoking previous token via provider API."
