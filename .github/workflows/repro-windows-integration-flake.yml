name: Reproduce Windows integration flake

on:
  workflow_dispatch:

jobs:
  repro-flake:
    name: Reproduce flake on windows-latest
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { pip install -r requirements.txt }
          # ensure pytest is available for test runs
          python -m pip install pytest

      - name: Run repeated e2e test runs
        run: |
          mkdir flake-logs
          # collect runner environment and tool info for triage
          "[RUNNER INFO]" | Out-File -FilePath flake-logs/runner_info.txt -Encoding utf8
          Get-ChildItem env: | Sort-Object Name | Out-String | Out-File flake-logs/runner_info.txt -Append -Encoding utf8
          python --version 2>&1 | Out-File -FilePath flake-logs/runner_info.txt -Append -Encoding utf8
          python -m pip freeze 2>&1 | Out-File -FilePath flake-logs/runner_info.txt -Append -Encoding utf8
          if (Get-Command psql -ErrorAction SilentlyContinue) { Get-Command psql | Out-String | Out-File flake-logs/runner_info.txt -Append -Encoding utf8 }
          $failed = $false
          for ($i=1; $i -le 20; $i++) {
            $file = "flake-logs/run_$i.txt"
            "--- RUN $i ---" | Out-File -FilePath $file -Encoding utf8
            python -m pytest tests/e2e -k preprod_infra -q 2>&1 | Tee-Object -FilePath $file -Append
            if ($LASTEXITCODE -ne 0) { "FAILED with exit $LASTEXITCODE" | Out-File -FilePath $file -Append; $failed = $true; break }
          }
          if (-not (Test-Path flake-logs/summary.txt)) { "runs_completed=$i; failed=$failed" | Out-File flake-logs/summary.txt -Encoding utf8 }
          # always exit 0 so upload step runs and artifacts are collected
          exit 0

      - name: Ensure artifact present
        run: |
          if (-not (Test-Path flake-logs)) { mkdir flake-logs }
          if (-not (Test-Path flake-logs/summary.txt)) { "no_runs_collected=true" | Out-File flake-logs/summary.txt -Encoding utf8 }

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flake-logs
          path: flake-logs
