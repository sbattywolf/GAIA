name: Reproduce Windows integration flake

on:
  workflow_dispatch:

jobs:
  repro-flake:
    name: Reproduce flake on windows-latest
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          # install requirements with retries to avoid transient network/setup failures
          if (Test-Path requirements.txt) {
            $tries=0; $max=3; while ($tries -lt $max) {
              try {
                python -m pip install -r requirements.txt 2>&1 | Tee-Object -FilePath .\flake-logs\pip_install.txt -Append
                break
              } catch {
                $tries++
                Start-Sleep -Seconds (5 * $tries)
                if ($tries -ge $max) { Write-Output "pip install failed after $max attempts"; exit 1 }
              }
            }
          }
          # ensure pytest is available for test runs (retry)
          $tries=0; $max=3; while ($tries -lt $max) {
            try { python -m pip install pytest 2>&1 | Tee-Object -FilePath .\flake-logs\pip_install.txt -Append; break } catch { $tries++; Start-Sleep -Seconds (5 * $tries); if ($tries -ge $max) { Write-Output "pytest install failed after $max attempts"; exit 1 } }
          }

      - name: Run repeated e2e test runs
        run: |
          # smoke artifact to validate upload pathway
          if (-not (Test-Path flake-logs)) { mkdir flake-logs }
          "smoke: ok" | Out-File -FilePath flake-logs/test-ok.txt -Encoding utf8

          mkdir flake-logs
          # collect runner environment and tool info for triage
          "[RUNNER INFO]" | Out-File -FilePath flake-logs/runner_info.txt -Encoding utf8
          Get-ChildItem env: | Sort-Object Name | Out-String | Out-File flake-logs/runner_info.txt -Append -Encoding utf8
          python --version 2>&1 | Out-File -FilePath flake-logs/runner_info.txt -Append -Encoding utf8
          python -m pip freeze 2>&1 | Out-File -FilePath flake-logs/runner_info.txt -Append -Encoding utf8
          if (Get-Command psql -ErrorAction SilentlyContinue) { Get-Command psql | Out-String | Out-File flake-logs/runner_info.txt -Append -Encoding utf8 }
          $failed = $false
          for ($i=1; $i -le 20; $i++) {
            $file = "flake-logs/run_$i.txt"
            "--- RUN $i ---" | Out-File -FilePath $file -Encoding utf8
            # attempt pytest up to 3 times per run to reduce transient failures
            $attempt=0; $maxAttempt=3; $rc=1
            while ($attempt -lt $maxAttempt) {
              $attempt++
              "[ATTEMPT] run=$i attempt=$attempt" | Out-File -FilePath $file -Append -Encoding utf8
              python -m pytest tests/e2e -k preprod_infra -q 2>&1 | Tee-Object -FilePath $file -Append
              $rc = $LASTEXITCODE
              if ($rc -eq 0) { break }
              Start-Sleep -Seconds (3 * $attempt)
            }
            if ($rc -ne 0) { "FAILED with exit $rc after $attempt attempts" | Out-File -FilePath $file -Append; $failed = $true; break }
          }
          if (-not (Test-Path flake-logs/summary.txt)) { "runs_completed=$i; failed=$failed" | Out-File flake-logs/summary.txt -Encoding utf8 }
          # always exit 0 so upload step runs and artifacts are collected
          exit 0

      - name: Ensure artifact present
        run: |
          if (-not (Test-Path flake-logs)) { mkdir flake-logs }
          if (-not (Test-Path flake-logs/summary.txt)) { "no_runs_collected=true" | Out-File flake-logs/summary.txt -Encoding utf8 }

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flake-logs
          path: flake-logs
