name: Auto PR Bot

on:
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create branch and small change
        id: make_change
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "gaia-bot"
          git config user.email "gaia-bot@example.com"
          BRANCH="auto/pr-$(date +%s)"
          git checkout -b "$BRANCH"
          echo "Auto PR generated at $(date -u --iso-8601=seconds)" >> .auto_pr_log
          git add .auto_pr_log
          set +e
          git commit -m "chore: auto PR update" || true
          set -e
          git push --set-upstream origin "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        uses: actions/github-script@v6
        with:
          script: |
            const branch = "${{ steps.make_change.outputs.branch }}";
            const title = `Auto PR: small maintenance (${branch})`;
            const body = "This PR was opened by the GAIA auto-PR bot for a small, non-destructive maintenance change.";
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: branch,
              base: 'main',
              body,
            });
            core.info(`PR created: ${pr.data.html_url}`);
