# HISTORY_REWRITE_PLAN â€” Safe purge of leaked secrets

Purpose
- Provide a conservative, fully reversible procedure to remove leaked secrets from repository history.
- Do not run without team approval and a full backup of the repository (mirror clone).

High-level steps
1. Rotate the leaked secrets immediately (do not wait for history rewrite).
2. Create a local bare mirror backup of the repository.
3. Build a replace-text file listing exact secret strings or token patterns to rewrite.
4. Run `git filter-repo` on a local mirror as a dry run and inspect results.
5. Test on a cloned remote mirror and run repo-level checks (CI, detect-secrets, smoke imports).
6. Coordinate with team: announce forced-push, request everyone to stop pushing and back up their work.
7. Force-push cleaned refs to origin and verify repository rules and CI status.
8. Rotate any remaining credentials and close the incident.

Prerequisites
- Install `git-filter-repo` (Python):

```powershell
python -m pip install git-filter-repo
```

- Ensure `gh` CLI and required repo permissions are available for push and branch-protection updates.
- Have a secure place to store backups (not in the same repo): e.g., an S3 bucket or a local archive.

Detailed commands (PowerShell / cross-platform notes)

1) Immediate rotation
- Revoke and recreate any leaked GitHub PAT, Telegram tokens, or other secrets before changing history.
- Update Actions Secrets with new tokens.

2) Create a bare mirror backup

```powershell
# from repo root
cd ..
git clone --mirror E:\Workspaces\Git\GAIA GAIA-mirror.git
tar -czf GAIA-mirror-backup-$(Get-Date -Format yyyyMMddT%H%M%SZ).tar.gz GAIA-mirror.git
```

3) Create `replace-text.txt`
- Format: one replacement per line: `OLD_TOKEN==>REDACTED`
- Example (do NOT include real tokens in shared docs):

```
ghp_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX==>REDACTED_GITHUB_TOKEN
telegram_bot_token_example==>REDACTED_TELEGRAM_TOKEN
```

Save this file outside the working repo (e.g., `~/replace-text.txt`).

4) Test rewrite locally on a fresh clone

```powershell
# Make a fresh clone (not your working tree)
git clone E:\Workspaces\Git\GAIA GAIA-clean-test
cd GAIA-clean-test
# Run filter-repo (this rewrites all branches and tags)
python -m git_filter_repo --replace-text ../replace-text.txt --force
# Inspect commits, run `detect-secrets scan`, run tests, and run CI smoke steps locally
```

- After rewrite, run `detect-secrets scan` and `pre-commit run --all-files` inside `GAIA-clean-test`. Confirm no secrets remain.

5) Coordinate with team
- Announce UTC time for maintenance window.
- Ask all contributors to:
  - Push or backup local branches (git bundle or `git push origin <branch>` if allowed before freeze).
  - Pause pushes during the rewrite.

6) Execute on mirror and push

```powershell
# operate on the mirror clone (bare)
cd ../GAIA-mirror.git
# apply the same replace-text to the mirror
python -m git_filter_repo --replace-text ../replace-text.txt --force
# optionally run additional checks here (bare-repo inspection)
# push cleaned refs to origin (force)
git push --mirror https://github.com/OWNER/REPO.git
```

Notes:
- Use `--force` only on the mirror push and only after team sign-off.
- If GitHub push-protection blocks the push, use the web UI to temporarily unblock or follow GitHub guidance to resolve blocked pushes.

7) Post-push steps
- Verify GitHub repo: run `detect-secrets scan` against default branch via Actions or locally against remote.
- Update `.secrets.baseline` if some false positives remain.
- Invalidate tokens, rotate any secrets that were in the history even if redacted.
- Communicate to the team to re-clone or rebase local work: provide exact rebase instructions.
  - Easiest: ask contributors to move their local commits onto fresh clones.

8) Rebuild CI caches & run full test suite
- Re-enable any branch-protection quick blocks; confirm CI passes on `main`/`master`.

Rollback plan
- If something goes wrong, use the mirror backup tarball to restore original refs and open an incident.

Security & policy notes
- Do not publish `replace-text.txt` with real secrets.
- Consider contacting GitHub Support if you need assistance removing sensitive data from forks or cached mirrors.

Approval
- This plan is destructive to commit history. I will NOT execute these steps until you explicitly approve and provide:
  - confirmation that leaked tokens were rotated, and
  - a target time window for the forced-push, and
  - a list of branches to preserve (if any) and a list of users to notify.

References
- https://github.com/newren/git-filter-repo
- https://docs.github.com/en/code-security/secret-scanning/working-with-secret-scanning-and-push-protection

---
(Generated by agent for owner review.)
